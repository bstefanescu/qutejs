{"version":3,"file":"index.cjs.js","sources":["../src/index.js"],"sourcesContent":["\nimport fs from 'fs';\nimport os from 'os';\nimport path from 'path';\n\nimport findCacheDir from 'find-cache-dir';\nimport { addHook } from 'pirates';\nimport { sync as mkdirp } from 'mkdirp';\n\nimport Compiler from '@qutejs/compiler';\n\nvar revertHook = null; // set when hook installed\nvar transpiling = false;\n\nvar cache;\n\nvar DEFAULT_EXTS = ['.jsq'];\nvar CACHE_FILE = findCacheDir({name: 'qute'}) || os.tmpdir();\n\nfunction Cache(filename) {\n\n\tif (!filename) filename = path.join(CACHE_FILE, '/qute-register.json');\n\n\tthis.get = function(key) {\n\t\treturn data[key];\n\t}\n\n\tthis.put = function(key, value) {\n\t\tdata[key] = value;\n\t\tdirty = true;\n\t}\n\tthis.clear = function() {\n\t\tdata = {};\n\t\tdirty = true;\n\t}\n\tthis.save = function() {\n\t\tstore();\n\t}\n\n\tfunction load() {\n\t\ttry {\n\t\t    return JSON.parse(fs.readFileSync(FILENAME));\n\t\t} catch (err) {\n\t\t\treturn {};\n\t\t}\n\t}\n\n\tfunction store() {\n\t\tif (dirty) {\n\t\t\ttry {\n\t\t\t\tmkdirp(path.dirname(filename));\n\t\t\t\tfs.writeFileSync(filename, JSON.stringify(data, null, '  '));\n\t\t\t} catch(err) {\n\t\t\t\tconsole.log('Failed to write qute-register cache', err.stack);\n\t\t\t\tdata = {};\n\t\t\t} finally {\n\t\t\t\tdirty = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tvar dirty = false;\n\tvar data = load();\n\n\tprocess.on(\"exit\", store);\n  \tprocess.nextTick(store);\n}\n\n\nfunction mtime(filename) {\n  return fs.statSync(filename).mtime.getTime();\n}\n\nfunction transpile(code) {\n\treturn new Compiler().transpile(code);\n}\n\nfunction cachedTranspile(code, filename) {\n\tvar key = filename; //TODO improve cache key\n\tvar cached = cache.get(key);\n\tvar tm = mtime(filename);\n\tif (!cached || cached.mtime !== tm) {\n\t\tcached = { code: transpile(code), mtime: tm };\n\t\tcache.put(cached);\n\t}\n\treturn cached.code;\n}\n\nfunction transpileHook(code, filename) {\n\tif (transpiling) return code;\n\ttry {\n\t\ttranspiling = true;\n\t\treturn cache ? cachedTranspile(code, filename) : transpile(code);\n\t} finally {\n\t\ttranspiling = false;\n\t}\n}\n\nfunction revert() {\n  \tif (revertHook) {\n  \t\trevertHook();\n  \t\trevertHook = null;\n\t}\n}\n\n/**\n * Default options:\n * - extensions: ['.jsq']\n * - ignoreNodeModules: true\n * - cache: true\n * - dev: false //TODO\n */\nfunction register(opts) {\n  var exts = DEFAULT_EXTS, ignoreNodeModules = true;\n  if (opts) {\n  \t  if ('extensions' in opts) exts = opts.extensions;\n  \t  if ('ignoreNodeModules' in opts) ignoreNodeModules = opts.ignoreNodeModules;\n  }\n\n  revert();\n\n  var useCache = !opts || opts.cache !== false;\n  if (useCache && !cache) {\n  \t  cache = new Cache();\n  }\n\n  revertHook = addHook(transpileHook, { exts: exts, ignoreNodeModules: ignoreNodeModules });\n  return revert;\n}\n\n\n// register with default opts\nregister();\n\n// allow re-registration with custom opts: require('qute-register')(opts)\nexport default function(opts) {\n\treturn register(opts);\n};\n\n"],"names":["mkdirp","addHook"],"mappings":";;;;;;;;;;;;AAWA,IAAI,UAAU,GAAG,IAAI,CAAC;AACtB,IAAI,WAAW,GAAG,KAAK,CAAC;AACxB;AACA,IAAI,KAAK,CAAC;AACV;AACA,IAAI,YAAY,GAAG,CAAC,MAAM,CAAC,CAAC;AAC5B,IAAI,UAAU,GAAG,YAAY,CAAC,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC,IAAI,EAAE,CAAC,MAAM,EAAE,CAAC;AAC7D;AACA,SAAS,KAAK,CAAC,QAAQ,EAAE;AACzB;AACA,CAAC,IAAI,CAAC,QAAQ,EAAE,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,qBAAqB,CAAC,CAAC;AACxE;AACA,CAAC,IAAI,CAAC,GAAG,GAAG,SAAS,GAAG,EAAE;AAC1B,EAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;AACnB,GAAE;AACF;AACA,CAAC,IAAI,CAAC,GAAG,GAAG,SAAS,GAAG,EAAE,KAAK,EAAE;AACjC,EAAE,IAAI,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;AACpB,EAAE,KAAK,GAAG,IAAI,CAAC;AACf,GAAE;AACF,CAAC,IAAI,CAAC,KAAK,GAAG,WAAW;AACzB,EAAE,IAAI,GAAG,EAAE,CAAC;AACZ,EAAE,KAAK,GAAG,IAAI,CAAC;AACf,GAAE;AACF,CAAC,IAAI,CAAC,IAAI,GAAG,WAAW;AACxB,EAAE,KAAK,EAAE,CAAC;AACV,GAAE;AACF;AACA,CAAC,SAAS,IAAI,GAAG;AACjB,EAAE,IAAI;AACN,MAAM,OAAO,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,YAAY,CAAC,QAAQ,CAAC,CAAC,CAAC;AACnD,GAAG,CAAC,OAAO,GAAG,EAAE;AAChB,GAAG,OAAO,EAAE,CAAC;AACb,GAAG;AACH,EAAE;AACF;AACA,CAAC,SAAS,KAAK,GAAG;AAClB,EAAE,IAAI,KAAK,EAAE;AACb,GAAG,IAAI;AACP,IAAIA,WAAM,CAAC,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC;AACnC,IAAI,EAAE,CAAC,aAAa,CAAC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;AACjE,IAAI,CAAC,MAAM,GAAG,EAAE;AAChB,IAAI,OAAO,CAAC,GAAG,CAAC,qCAAqC,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC;AAClE,IAAI,IAAI,GAAG,EAAE,CAAC;AACd,IAAI,SAAS;AACb,IAAI,KAAK,GAAG,KAAK,CAAC;AAClB,IAAI;AACJ,GAAG;AACH,EAAE;AACF;AACA,CAAC,IAAI,KAAK,GAAG,KAAK,CAAC;AACnB,CAAC,IAAI,IAAI,GAAG,IAAI,EAAE,CAAC;AACnB;AACA,CAAC,OAAO,CAAC,EAAE,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;AAC3B,GAAG,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;AAC3B,CAAC;AACD;AACA;AACA,SAAS,KAAK,CAAC,QAAQ,EAAE;AACzB,EAAE,OAAO,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;AAC/C,CAAC;AACD;AACA,SAAS,SAAS,CAAC,IAAI,EAAE;AACzB,CAAC,OAAO,IAAI,QAAQ,EAAE,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;AACvC,CAAC;AACD;AACA,SAAS,eAAe,CAAC,IAAI,EAAE,QAAQ,EAAE;AACzC,CAAC,IAAI,GAAG,GAAG,QAAQ,CAAC;AACpB,CAAC,IAAI,MAAM,GAAG,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;AAC7B,CAAC,IAAI,EAAE,GAAG,KAAK,CAAC,QAAQ,CAAC,CAAC;AAC1B,CAAC,IAAI,CAAC,MAAM,IAAI,MAAM,CAAC,KAAK,KAAK,EAAE,EAAE;AACrC,EAAE,MAAM,GAAG,EAAE,IAAI,EAAE,SAAS,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC;AAChD,EAAE,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;AACpB,EAAE;AACF,CAAC,OAAO,MAAM,CAAC,IAAI,CAAC;AACpB,CAAC;AACD;AACA,SAAS,aAAa,CAAC,IAAI,EAAE,QAAQ,EAAE;AACvC,CAAC,IAAI,WAAW,EAAE,OAAO,IAAI,CAAC;AAC9B,CAAC,IAAI;AACL,EAAE,WAAW,GAAG,IAAI,CAAC;AACrB,EAAE,OAAO,KAAK,GAAG,eAAe,CAAC,IAAI,EAAE,QAAQ,CAAC,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;AACnE,EAAE,SAAS;AACX,EAAE,WAAW,GAAG,KAAK,CAAC;AACtB,EAAE;AACF,CAAC;AACD;AACA,SAAS,MAAM,GAAG;AAClB,GAAG,IAAI,UAAU,EAAE;AACnB,IAAI,UAAU,EAAE,CAAC;AACjB,IAAI,UAAU,GAAG,IAAI,CAAC;AACtB,EAAE;AACF,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS,QAAQ,CAAC,IAAI,EAAE;AACxB,EAAE,IAAI,IAAI,GAAG,YAAY,EAAE,iBAAiB,GAAG,IAAI,CAAC;AACpD,EAAE,IAAI,IAAI,EAAE;AACZ,KAAK,IAAI,YAAY,IAAI,IAAI,EAAE,IAAI,GAAG,IAAI,CAAC,UAAU,CAAC;AACtD,KAAK,IAAI,mBAAmB,IAAI,IAAI,EAAE,iBAAiB,GAAG,IAAI,CAAC,iBAAiB,CAAC;AACjF,GAAG;AACH;AACA,EAAE,MAAM,EAAE,CAAC;AACX;AACA,EAAE,IAAI,QAAQ,GAAG,CAAC,IAAI,IAAI,IAAI,CAAC,KAAK,KAAK,KAAK,CAAC;AAC/C,EAAE,IAAI,QAAQ,IAAI,CAAC,KAAK,EAAE;AAC1B,KAAK,KAAK,GAAG,IAAI,KAAK,EAAE,CAAC;AACzB,GAAG;AACH;AACA,EAAE,UAAU,GAAGC,eAAO,CAAC,aAAa,EAAE,EAAE,IAAI,EAAE,IAAI,EAAE,iBAAiB,EAAE,iBAAiB,EAAE,CAAC,CAAC;AAC5F,EAAE,OAAO,MAAM,CAAC;AAChB,CAAC;AACD;AACA;AACA;AACA,QAAQ,EAAE,CAAC;AACX;AACA;AACe,cAAQ,CAAC,IAAI,EAAE;AAC9B,CAAC,OAAO,QAAQ,CAAC,IAAI,CAAC,CAAC;AACvB;;;;"}