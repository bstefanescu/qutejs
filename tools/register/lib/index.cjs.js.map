{"version":3,"file":"index.cjs.js","sources":["../src/index.js"],"sourcesContent":["\nimport fs from 'fs';\nimport os from 'os';\nimport path from 'path';\n\nimport findCacheDir from 'find-cache-dir';\nimport { addHook } from 'pirates';\nimport { sync as mkdirp } from 'mkdirp';\n\nimport Compiler from '@qutejs/compiler';\n\nvar revertHook = null; // set when hook installed\nvar transpiling = false;\n\nvar cache;\n\nvar DEFAULT_EXTS = ['.jsq'];\nvar CACHE_FILE = findCacheDir({name: 'qute'}) || os.tmpdir();\n\nfunction Cache(filename) {\n\n\tif (!filename) filename = path.join(CACHE_FILE, '/qute-register.json');\n\n\tthis.get = function(key) {\n\t\treturn data[key];\n\t}\n\n\tthis.put = function(key, value) {\n\t\tdata[key] = value;\n\t\tdirty = true;\n\t}\n\tthis.clear = function() {\n\t\tdata = {};\n\t\tdirty = true;\n\t}\n\tthis.save = function() {\n\t\tstore();\n\t}\n\n\tfunction load() {\n\t\ttry {\n\t\t    return JSON.parse(fs.readFileSync(FILENAME));\n\t\t} catch (err) {\n\t\t\treturn {};\n\t\t}\n\t}\n\n\tfunction store() {\n\t\tif (dirty) {\n\t\t\ttry {\n\t\t\t\tmkdirp(path.dirname(filename));\n\t\t\t\tfs.writeFileSync(filename, JSON.stringify(data, null, '  '));\n\t\t\t} catch(err) {\n\t\t\t\tconsole.log('Failed to write qute-register cache', err.stack);\n\t\t\t\tdata = {};\n\t\t\t} finally {\n\t\t\t\tdirty = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tvar dirty = false;\n\tvar data = load();\n\n\tprocess.on(\"exit\", store);\n  \tprocess.nextTick(store);\n}\n\n\nfunction mtime(filename) {\n  return fs.statSync(filename).mtime.getTime();\n}\n\nfunction transpile(code) {\n\treturn new Compiler().transpile(code);\n}\n\nfunction cachedTranspile(code, filename) {\n\tvar key = filename; //TODO improve cache key\n\tvar cached = cache.get(key);\n\tvar tm = mtime(filename);\n\tif (!cached || cached.mtime !== tm) {\n\t\tcached = { code: transpile(code), mtime: tm };\n\t\tcache.put(cached);\n\t}\n\treturn cached.code;\n}\n\nfunction transpileHook(code, filename) {\n\tif (transpiling) return code;\n\ttry {\n\t\ttranspiling = true;\n\t\treturn cache ? cachedTranspile(code, filename) : transpile(code);\n\t} finally {\n\t\ttranspiling = false;\n\t}\n}\n\nfunction revert() {\n  \tif (revertHook) {\n  \t\trevertHook();\n  \t\trevertHook = null;\n\t}\n}\n\n/**\n * Default options:\n * - extensions: ['.jsq']\n * - ignoreNodeModules: true\n * - cache: true\n * - dev: false //TODO\n */\nfunction register(opts) {\n  var exts = DEFAULT_EXTS, ignoreNodeModules = true;\n  if (opts) {\n  \t  if ('extensions' in opts) exts = opts.extensions;\n  \t  if ('ignoreNodeModules' in opts) ignoreNodeModules = opts.ignoreNodeModules;\n  }\n\n  revert();\n\n  var useCache = !opts || opts.cache !== false;\n  if (useCache && !cache) {\n  \t  cache = new Cache();\n  }\n\n  revertHook = addHook(transpileHook, { exts: exts, ignoreNodeModules: ignoreNodeModules });\n  return revert;\n}\n\n\n// register with default opts\nregister();\n\n// allow re-registration with custom opts: require('qute-register')(opts)\nexport default function(opts) {\n\treturn register(opts);\n};\n\n"],"names":["mkdirp","addHook"],"mappings":"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"}